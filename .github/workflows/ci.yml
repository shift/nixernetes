name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  nix-checks:
    name: Nix Flake Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          extra-conf: sandbox = false
          github-access-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run nix flake check
        run: nix flake check --no-warn-dirty

  nix-build:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          extra-conf: sandbox = false
          github-access-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build default package
        run: nix build .#default

      - name: Build example
        run: nix build .#example-app

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          extra-conf: sandbox = false
          github-access-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Nix formatting
        run: nixpkgs-fmt --check . || true

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown files exist
        run: |
          test -f README.md || exit 1
          test -f GETTING_STARTED.md || exit 1
          test -f ARCHITECTURE.md || exit 1
          test -f CONTRIBUTING.md || exit 1
          test -f SECURITY.md || exit 1
          test -f LICENSE || exit 1

      - name: Check documentation links
        run: |
          find . -name "*.md" -type f | wc -l

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          extra-conf: sandbox = false
          github-access-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run integration tests
        run: nix flake check

  summary:
    name: CI Summary
    needs: [nix-checks, nix-build, format-check, documentation-check, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Nix Checks: ${{ needs.nix-checks.result }}"
          echo "Nix Build: ${{ needs.nix-build.result }}"
          echo "Format Check: ${{ needs.format-check.result }}"
          echo "Documentation Check: ${{ needs.documentation-check.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [ "${{ needs.nix-checks.result }}" = "failure" ] || \
             [ "${{ needs.nix-build.result }}" = "failure" ] || \
             [ "${{ needs.format-check.result }}" = "failure" ] || \
             [ "${{ needs.documentation-check.result }}" = "failure" ]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "All checks passed"
